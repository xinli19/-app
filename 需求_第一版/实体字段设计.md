# 实体类详细字段说明

## 核心实体

### 1. 人员 (Person)
该实体为系统用户的基本信息。

| 字段名 | 类型    | 描述                                   |
| :----- | :------ | :------------------------------------- |
| 人员ID     | UUID    | 人员的唯一标识符，数据库主键                  |
| 姓名   | String  | 人员的真实姓名                         |
| 状态   | Enum    | 人员的工作状态，正常，无效，...        |
| 邮箱   | String  | 人员的邮箱                             |
| 电话   | String  | 人员的电话                             |

关系与说明:
- 通过“人员-角色关系表”维护多角色关系（教师、运营、教研），不再使用数组字段。

**关系:** 一个人员可以有多个职位。
### 1.x 人员-角色关系表 (PersonRole)
| 字段名     | 类型        | 描述                  |
| :--------- | :---------- | :-------------------- |
| 关系ID     | UUID        | 主键                  |
| 人员ID     | Foreign Key | 关联人员(Person)     |
| 角色       | Enum        | 教师、教研、运营       |
| created_at | DateTime    | 创建时间（UTC）       |

### 2. 学员 (Student)
| 字段名     | 类型           | 描述                                                         |
| :--------- | :------------- | :----------------------------------------------------------- |
| 学员ID     | Integer        | 学员的唯一标识符，数据库主键                                 |
| 小鹅通ID   | String         | 目前由外部提供                                               |
| 昵称   | String         | 学员在系统中显示的昵称                                       |
| 标签       | Array          | 为学员添加的分类标签，例如：困难、练琴时间少、老年人、有基础、无基础、需严格要求、需宽松要求 |
| 教师印象   | String         | 教师在点评时产生的学员印象.               |
| 运营备注   | String (长文本) | 运营人员添加的关于学员的备注信息                             |

**关系:**
- 一个 **学员** 可以有多条 **课程记录**。
- 一个 **学员** 可以有多条 **点评任务**。
- 一个 **学员** 可以有多条 **提醒事项**。

#### 2.1 辅助: 课程记录
课程记录记录学生所属的课程体系。每当产生课程体系改变的时候，通过关闭旧记录、创建新记录的方式保留完整的课程变更历史。

| 字段名       | 类型      | 描述                         |
| :----------- | :-------- | :--------------------------- |
| 课程记录ID  | Integer   | 唯一标识符，数据库主键       |
| 关联学员     | Foreign key  | 关联学员实体的ID             |
| 关联课程     | Foreign Key | 关联课程实体ID               |
| 课程状态     | Enum      | 未开始，学习中，已学完，暂停，转课 |
| 记录状态     | Enum      | 有效，已关闭                 |
| 开始时间     | DateTime  | 该条学习记录开始的时间       |
| 结束时间     | DateTime  | 该条学习记录结束的时间       |

规则与说明:
- 同一时间可以存在多个“有效”的课程记录（允许并行课程）。
- 课程版本冻结：课程/课/曲目引用保留版本指针，用于历史回查。

**关系:** 一个学生可以有多个课程记录。

---

## 辅助实体

### 1. 点评记录 (Feedback Record)
教师依据被分配到的点评任务进行教学活动，产生点评记录。

| 字段名           | 类型        | 描述                           |
| :--------------- | :---------- | :----------------------------- |
| 记录ID           | Integer     | 点评记录的唯一标识符，主键。     |
| 关联学员         | Foreign Key | 关联学员实体的ID。             |
| 关联点评教师     | Foreign Key | 关联人员实体的ID。             |
| 记录创建时间     | DateTime    | 记录的创建时间。               |
| 关联点评任务     | Foreign Key | 一条点评任务最终只产生一条点评记录 |
| 教师点评内容     | String      | 教师对课程的评价内容。         |
| 教研反馈内容     | String      | 教研人员对该条课程记录的反馈。 |
| 是否产生教师印象 | Boolean     | 若为 true，写入学员当前印象并保留溯源 |

**关系:** 点评记录属于一个 **学员**，由一位 **教师** 创建，由一条 **点评任务** 产生。一个点评任务关联一条点评记录。

#### 1.1 辅助: 点评曲目明细表
点评曲目明细表负责记录本次点评涉及的曲目。

| 字段名         | 类型        | 描述                   |
| :------------- | :---------- | :--------------------- |
| 明细ID         | Integer     | 唯一标识符，主键。     |
| 关联点评记录   | Foreign Key | 关联点评记录的ID。     |
| 曲目ID         | Foreign Key | 关联点评曲目的ID。     |

#### 1.2 学员曲目状态表
（原“点评曲目状态表”统一命名为“学员曲目状态表”，不新增新表名）

| 字段名         | 类型        | 描述                   |
| :------------- | :---------- | :--------------------- |
| 状态ID         | Integer     | 唯一标识符，主键。     |
| 关联点评记录   | Foreign Key | 关联点评记录的ID。     |
| 曲目ID         | Foreign Key | 关联点评曲目的ID。     |
| 学员ID         | Foreign Key | 关联学员实体的ID       |
| 被点评次数     | Integer     |                        |
| 最后点评时间   | DateTime    |                        |

流程:
1.  创建点评记录主表
2.  创建点评曲目明细表，记录本次被点评的曲目。
3.  对每个曲目执行：
    - 查询学员曲目状态表
    - 如果记录存在：被点评次数 +1
    - 如果记录不存在：创建新记录，被点评次数 = 1
    - 更新最后点评时间

---

### 2. 点评任务 (Evaluation Task)
教师的工作任务，根据点评任务，教师在线下进行教学活动，产生课程记录。

| 字段名         | 类型        | 描述                                                         |
| :------------- | :---------- | :----------------------------------------------------------- |
| 任务ID         | Integer     | 点评任务的唯一标识符，主键。                                   |
| 分配批次ID     | Integer     | 通过"分配批次ID"来关联同一次分配的多个任务，自动创建         |
| 学员           | Foreign Key | 关联学员实体的ID。                                           |
| 任务创建时间   | DateTime    | 任务的创建时间。                                             |
| 任务负责教师   | Foreign Key | 关联人员实体的ID。                                           |
| 任务状态       | Enum        | 任务的当前状态，例如：未完成、已完成。                       |
| 任务备注       | Rich Text   | 支持富文本                                 |
| 任务来源       | enum        | 任务的来源，可以是：教研、教师                               |
| 创建人         | Foreign Key | 关联人员实体的ID                                             |

---

### 3. 提醒事项 (Reminder)
角色筛选出特定学生推送提醒事项。

| 字段名           | 类型          | 描述                                                         |
| :--------------- | :------------ | :----------------------------------------------------------- |
| 提醒事项ID       | Integer       | 提醒事项的唯一标识符，主键。                                   |
| 提醒事项创建时间 | DateTime      | 提醒的创建时间。                                             |
| 紧急度           | Enum          | 提醒的紧急程度，可以是：紧急需处理、不紧急需留意。           |
| 接受人           | Foreign Key   | 接收提醒的人员ID（教师、教研或运营）。                       |
| 发送人           | Foreign Key   | 发送提醒的人员ID（教师、教研或运营）。                       |
| 时效             | Time Range    | 默认一周内，可设置                                           |
| 端到端类别       | enum          | 系统根据接收人和发送人信息自动填充（T→R/T→O/R→T/R→O/O→T/O→R） |
| 多接收人         | 子表          | ReminderRecipient(reminder_id, person_id, is_read, read_at)   |
| 提醒事项分类     | Enum          | 提醒的分类，例如：教学效果差、学员态度问题、有伤病等。       |
| 学员             | Foreign Key   | 关联学员实体的ID。（不是必选项）                             |
| 评价             | Foreign Key   | 关联评价的ID。（不是必选项）                                 |
| 提醒内容         | String        | 提醒内容的详细描述                                           |

**关系:** 提醒事项关联一个 **学员**，由一位 **教师、教研** 或 **运营** 人员发送，发送给一位或多位 **教师、教研** 或 **运营** 人员。

---

### 4. 公告 (Announcement)
公告由教研发送到全体教师。

| 字段名         | 类型          | 描述                                     |
| :------------- | :------------ | :--------------------------------------- |
| 公告ID         | Integer       | 公告的唯一标识符，主键。                   |
| 公告类型       | Enum          | 公告的分类，例如：学员伤病、教学提醒。     |
| 公告时效       | DateTime Range| 公告的有效时间范围。                     |
| 公告内容文本   | String        | 公告的具体内容。                         |
| 发布人         | Foreign Key   | 发布公告的人员ID。                       |

**关系:** 由 **教研** 人员发布，面向全体 **教师**。

---

### 5. 回访记录 (FollowUpRecord)
运营记录对学员的回访。

| 字段名               | 类型          | 描述                                                         |
| :------------------- | :------------ | :----------------------------------------------------------- |
| 回访ID               | String        | 回访的唯一标识符，数据库主键                                   |
| 学员                 | Foreign Key   | 关联学员实体的ID                                             |
| 回访序号             | Integer       | 显示这是该学员第几次回访                                     |
| 创建回访时间         | DateTime      | 记录的创建时间                                               |
| 回访状态             | Enum          | 未处理，已处理，关闭                                         |
| 回访内容             | String        | 运营人员回访学员的内容。                                     |
| 回访结果             | String        | 自由文本                                                     |
| 回访目的             | Enum          | 字典项（常规回访/问题跟进/续费提醒/投诉处理等）              |
| 紧急度               | Enum          | 高/中/低                                                     |
| 是否需要跟进        | boolean       |                                                              |
| 下次回访计划时间    | DateTime      |                                                              |
| 回访人员             | Foreign Key   | 记录操作人（人员ID）                                         |

联动:
- 当“是否需要跟进”为真，或临近“下次回访计划时间”时，系统在提前24小时自动生成提醒事项并推送给相关接收人。
回访结果            |               | (成功联系/未接通/需要再次跟进等)                              |
| 回访目的            |               | 1.每次填写不一样的文字 2.标签 常规回访/问题跟进/续费提醒/投诉处理等 3.标签+文字备注 |
| 回访备注            |               | 自由文本                                                     |
| 紧急度              |               | 提醒的紧急程度，可以是：紧急需处理、不紧急需留意。           |
| 是否需要跟进        | boolean       | 比如本次任务已关闭，但需要在一个月之后再去做一次回访。       |
| 下次回访计划时间    |               |                                                              |

**关系:** 一个学员可以有多条回访任务。

---

### 6. 通知 (Notification)
系统中的通知。

| 字段名       | 类型        | 描述                             |
| :----------- | :---------- | :------------------------------- |
| 通知ID       | Integer     | 通知的唯一标识符，主键。           |
| 通知内容     | String      | 通知内容                         |
| 通知类型     | Enum        | 任务分配、任务完成、提醒接收、回访待办、公告发布 |
| 操作链接     | String      | link_type + link_id（跳转参数约定）         |
| 发送者       | Foreign Key | 发布公告的人员ID 或系统标识      |
| 接收者       | Foreign Key | 接受公告的人员ID                 |
| 是否已读     | boolean     | 通知是否已读                     |
| 操作链接     | String      | 点击通知后跳转的页面地址         |

---

### 7. 课程体系实体: 课程，课，曲目
本课程体系分为三个层级，第一个层级，课程，代表课程分类，比如基础班，中级班。第二个层级， 课，代表课程下的课，基础班 有26课, 中级班有25课。第三个层级，曲目，代表课程下的细分学习内容，用名称进行描述。

#### 7.1 课程

| 字段名           | 类型    | 描述                   |
| :--------------- | :------ | :--------------------- |
| 课程ID           | Integer | 课程的唯一标识符，主键。 |
| 课程状态         | Enum    | 启用，停用。           |
| 课程版本         | Enum    | 2024版，               |
| 课程内容描述     | String  | 对课程的描述           |

#### 7.2 课

| 字段名           | 类型        | 描述                                     |
| :--------------- | :---------- | :--------------------------------------- |
| 课ID             | Integer     | 课的唯一标识符，主键。                     |
| 关联课程         | Foreign Key | 该课所属的课程                           |
| 课状态           | Enum        | 启用，停用。                             |
| 课排序           | Integer     | 基础班 有26课, 中级班有25课。            |
| 分类             | Enum        | 基础版，零基础版                         |
| 课重点           | Enum        | 本课涉及的重点:手腕，手臂，抬指          |
| 课内容描述       | String      | 对课的描述                               |

#### 7.3 曲目

| 字段名           | 类型        | 描述                       |
| :--------------- | :---------- | :------------------------- |
| 曲目ID           | Integer     | 曲课的唯一标识符，主键。     |
| 关联课程         | Foreign Key | 基础班，中级班             |
| 关联课           | Foreign Key | 基础班 1-26, 中级班 1- 25  |
| 曲目状态         | Enum        | 启用，停用                 |
| 曲目属性         | Enum        | 练习曲，乐曲，技术练习。   |
| 曲目是否必修     | boolean     |                            |
| 曲目内容描述     | String      |                            |

**关系:**
- 一个课只能属于一个课程。
- 一个曲目只能属于一个课。
- 一个曲目只能属于一个课程 (通过课间接关联)。
- 一个课程可以有多个课。

i- 一个课可以有多个曲目。

说明与规则:
- 曲目刻度 = 子课（课） + 曲目；教师点评时可选择多个曲目。
- 课程版本需要冻结和回查（历史点评回看对应当时版本）。
- 点评流程：任务分配 → 教师提交点评 → 记录曲目明细 → 更新学员曲目状态表。
- 教师仅允许“删除（撤回）”由本人提交的点评记录；无时间窗口限制；删除完成后系统向教研发送通知。

## 全局建模约定
- 主键：全部使用 UUID（字符串）作为主键；外键显式化。
- 审计与软删除：除“学员”外，大部分业务表增加 created_at, created_by, updated_at, updated_by, deleted_at（软删除）；学员禁止删除。
- 时间与时区：所有时间字段统一采用 UTC 存储，前端本地化展示。
- 命名：数据库字段使用 snake_case；类名使用 PascalCase。
- 字典与枚举：枚举集中管理（状态、来源、类别、紧急度等），标签采用“固化字典 + 运营可自定义”的机制。
- 登录与角色：只有“人员（教师/教研/运营）”登录，学员不登录。角色采用中间表维护多角色关系。
- 索引：对高频搜索与筛选字段（学员ID/昵称/小鹅通ID、创建时间、状态、负责人、课程/课/曲目等）建立索引。
- 课程版本：版本需要冻结和回查，历史记录按当时版本回看。

### 2. 学员 (Student)
| 小鹅通ID     | String          | 唯一约束（导入唯一锚点）                                     |
| 昵称         | String          | 学员在系统中显示的昵称                                       |
| 备注名       | String          | 运营可维护的备注名                                           |
| 标签         | 多对多（字典+自定义） | 固化字典标签（困难、练琴时间少等）+ 运营自定义扩展               |
| 教师印象（当前） | String          | 学员当前的教师印象（当前态），在产生印象的点评记录上保留溯源       |
| 运营备注     | String (长文本) | 运营人员添加的关于学员的备注信息                             |

关系与说明:
- 教师印象“有源可溯”：在 FeedbackRecord 上记录“是否产生印象”及印象内容，Student.教师印象（当前）指向最新来源。
- 学员不可删除（禁止软删除）；可状态停用。

## 实体字段明细（首版）
说明
- 本节为“实体字段明细文档（首版）”，用于指导后续 Django 模型落地（不含业务流程代码）。
- 全局约定：主键统一 UUID；时间字段使用 UTC；大多数业务表支持软删除（deleted_at），Student 禁止删除；字段命名 snake_case，类名 PascalCase；高频筛选字段建立索引；课程体系采用版本化实体；提醒/公告“实效性”= now ∈ [start_at, end_at]，end_at 为空视为仍有效。
- 本节为标准口径，覆盖前文中示例性字段定义的差异处（以本节为准）。

通用字段（除特别说明外均适用）
- id: UUID, 必填, PK
- created_at: DateTime(UTC), 必填, 默认=now()
- created_by: FK(Person), 可空, on_delete=SET_NULL
- updated_at: DateTime(UTC), 必填, 默认=now(), 自动更新
- updated_by: FK(Person), 可空, on_delete=SET_NULL
- deleted_at: DateTime(UTC), 可空, 软删除标记（Student 不包含该字段）

1. 人员与角色
1.1 Person（人员）
- 字段
  - id: UUID, 必填, PK
  - name: String(100), 必填
  - status: Enum(PersonStatus), 必填, 默认=active
  - email: String(255), 可空
  - phone: String(32), 可空
  - [通用字段：created_*/updated_*，支持软删]
- 约束
  - 可选唯一：email 唯一（若业务需要），phone 唯一（若业务需要）
- 索引
  - idx_person_name(name), idx_person_email(email), idx_person_phone(phone), idx_person_status(status)
- 枚举
  - PersonStatus: active, inactive

1.2 PersonRole（人员-角色关系）
- 字段
  - id: UUID, 必填, PK
  - person_id: FK(Person), 必填, on_delete=CASCADE
  - role: Enum(RoleType), 必填
  - created_at: DateTime(UTC), 必填
- 约束
  - uq_person_role(person_id, role) 唯一
- 索引
  - idx_personrole_person(person_id), idx_personrole_role(role)
- 枚举
  - RoleType: teacher, researcher, operator

2. 学员与标签
2.1 Student（学员）
- 字段
  - id: UUID, 必填, PK
  - xiaoe_id: String(64), 必填, 唯一（导入唯一锚点）
  - nickname: String(100), 必填
  - remark_name: String(100), 可空
  - teacher_impression_current: Text, 可空（当前印象文本，溯源到 FeedbackRecord）
  - teacher_impression_source_id: FK(FeedbackRecord), 可空, on_delete=SET_NULL
  - operator_note: Text, 可空
  - status: Enum(StudentStatus), 必填, 默认=enabled
  - [通用字段：created_*/updated_*，禁止软删字段 deleted_at（不包含）]
- 约束
  - uq_student_xiaoe(xiaoe_id) 唯一
- 索引
  - idx_student_nickname(nickname), idx_student_remark(remark_name), idx_student_status(status), idx_student_xiaoe(xiaoe_id)
- 枚举
  - StudentStatus: enabled, disabled

2.2 Tag（标签）
- 字段
  - id: UUID, 必填, PK
  - name: String(64), 必填
  - is_custom: Boolean, 必填, 默认=true（true=运营自定义；false=固化字典）
  - description: String(255), 可空
  - [通用字段：created_*/updated_*，支持软删]
- 约束
  - uq_tag_name(name)（建议唯一，同一“已存在且未软删”范围内）
- 索引
  - idx_tag_name(name), idx_tag_is_custom(is_custom)
- 权限与删除
  - 运营可新增/重命名/删除自定义标签；删除为软删除，保留既有绑定历史。

2.3 StudentTag（学员-标签，多对多表）
- 字段
  - id: UUID, 必填, PK
  - student_id: FK(Student), 必填, on_delete=CASCADE
  - tag_id: FK(Tag), 必填, on_delete=PROTECT
  - [通用字段：created_*/updated_*，支持软删]
- 约束
  - uq_student_tag(student_id, tag_id) 唯一
- 索引
  - idx_student_tag_student(student_id), idx_student_tag_tag(tag_id)

3. 课程体系与版本化
3.1 Course（课程）
- 字段
  - id: UUID, 必填, PK
  - name: String(100), 必填
  - status: Enum(EnableStatus), 必填, 默认=enabled
  - description: Text, 可空
  - [通用字段：created_*/updated_*，支持软删]
- 约束
  - uq_course_name(name)
- 索引
  - idx_course_status(status)

3.2 Lesson（课）
- 字段
  - id: UUID, 必填, PK
  - course_id: FK(Course), 必填, on_delete=PROTECT
  - name: String(100), 必填
  - status: Enum(EnableStatus), 必填, 默认=enabled
  - sort_order: Integer, 必填
  - category: Enum(LessonCategory), 可空（如：basic, zero_basic）
  - focus: Enum(LessonFocus), 可空（多选时建议拆子表）
  - description: Text, 可空
  - [通用字段：created_*/updated_*，支持软删]
- 约束
  - uq_lesson_course_sort(course_id, sort_order)
- 索引
  - idx_lesson_course(course_id), idx_lesson_status(status), idx_lesson_sort(sort_order)

3.3 Piece（曲目）
- 字段
  - id: UUID, 必填, PK
  - course_id: FK(Course), 必填, on_delete=PROTECT
  - lesson_id: FK(Lesson), 必填, on_delete=PROTECT
  - name: String(150), 必填
  - status: Enum(EnableStatus), 必填, 默认=enabled
  - attribute: Enum(PieceAttribute), 必填
  - is_required: Boolean, 必填, 默认=true
  - description: Text, 可空
  - [通用字段：created_*/updated_*，支持软删]
- 约束
  - uq_piece_lesson_name(lesson_id, name)
- 索引
  - idx_piece_lesson(lesson_id), idx_piece_course(course_id), idx_piece_status(status), idx_piece_required(is_required)

3.x 版本化实体（冻结回查）
- CourseVersion
  - 字段：id(UUID) PK、course_id(FK Course, PROTECT)、version_label(String 64, 必填)、status(EnableStatus)、released_at(DateTime, 可空)、content_snapshot(Text, 可空)、[通用字段, 软删]
  - 约束：uq_course_version(course_id, version_label)
  - 索引：idx_course_version_course(course_id), idx_course_version_label(version_label)
- LessonVersion
  - 字段：id(UUID) PK、lesson_id(FK Lesson, PROTECT)、course_version_id(FK CourseVersion, PROTECT)、sort_order(Integer)、category(Enum LessonCategory)、focus(Enum LessonFocus)、description(Text)、[通用字段, 软删]
  - 约束：uq_lesson_version(lesson_id, course_version_id)
  - 索引：idx_lesson_version_course_ver(course_version_id), idx_lesson_version_lesson(lesson_id)
- PieceVersion
  - 字段：id(UUID) PK、piece_id(FK Piece, PROTECT)、lesson_version_id(FK LessonVersion, PROTECT)、attribute(Enum PieceAttribute)、is_required(Boolean)、description(Text)、[通用字段, 软删]
  - 约束：uq_piece_version(piece_id, lesson_version_id)
  - 索引：idx_piece_version_lesson_ver(lesson_version_id), idx_piece_version_piece(piece_id)

4. 学员课程记录与进度
4.1 CourseRecord（课程记录）
- 字段
  - id: UUID, 必填, PK
  - student_id: FK(Student), 必填, on_delete=CASCADE
  - course_id: FK(Course), 必填, on_delete=PROTECT
  - course_version_id: FK(CourseVersion), 必填, on_delete=PROTECT
  - course_status: Enum(CourseLearnStatus), 必填（未开始/学习中/已学完/暂停/转课）
  - record_status: Enum(RecordStatus), 必填（有效/已关闭）
  - start_at: DateTime(UTC), 必填
  - end_at: DateTime(UTC), 可空
  - [通用字段：created_*/updated_*，支持软删]
- 规则
  - 允许并行“有效”记录；保留全历史。
- 索引
  - idx_cr_student(student_id), idx_cr_course(course_id), idx_cr_course_ver(course_version_id)
  - idx_cr_status(record_status), idx_cr_period(start_at, end_at)

4.2 Progress 计算口径（文档口径，非表）
- 对每门课程：进度% = 至少被点评一次的曲目数（必修+选修） / 该课程曲目总数（必修+选修）
- 并行多个“有效课程记录”时按课程维度分别计算

5. 点评任务与点评记录
5.1 EvaluationTask（点评任务）
- 字段
  - id: UUID, 必填, PK
  - batch_id: UUID, 可空（同一次分配的批次号）
  - student_id: FK(Student), 必填, on_delete=PROTECT
  - assignee_id: FK(Person), 必填（任务负责教师）, on_delete=PROTECT
  - status: Enum(TaskStatus), 必填（未完成/已完成）
  - source: Enum(TaskSource), 必填（researcher/teacher）
  - note: Text（富文本）, 可空
  - created_by: FK(Person), 必填（创建者）
  - created_at/updated_at：通用；支持软删
- 约束
  - 可选唯一：每任务一条反馈（在 FeedbackRecord 端以 unique(task_id) 约束）
- 索引
  - idx_task_assignee(assignee_id, status), idx_task_student(student_id), idx_task_batch(batch_id), idx_task_source(source)
- 删除/回退
  - 教师删除本人点评后，该任务从“已完成”回退为“未完成”，返回其未完成任务列表。

5.2 FeedbackRecord（点评记录）
- 字段
  - id: UUID, 必填, PK
  - task_id: FK(EvaluationTask), 必填, on_delete=PROTECT（唯一关联）
  - student_id: FK(Student), 必填, on_delete=PROTECT
  - teacher_id: FK(Person), 必填（点评教师）, on_delete=PROTECT
  - created_at: DateTime(UTC), 必填
  - teacher_content: Text, 必填
  - researcher_feedback: Text, 可空
  - produce_impression: Boolean, 必填, 默认=false
  - impression_text: Text, 可空（当 produce_impression=true 时写入，用于更新 Student 当前印象与溯源）
  - [通用字段：updated_*；支持软删]
- 约束
  - uq_feedback_task(task_id) 唯一（一任务一反馈）
- 索引
  - idx_feedback_student(student_id, created_at), idx_feedback_teacher(teacher_id, created_at), idx_feedback_task(task_id)
- 删除联动
  - 仅提交教师可删；无时间窗口；删除后通知教研；回滚 StudentPieceStatus 与 Student.teacher_impression_current（若为当前溯源则回退/清空）；关联任务状态回退为未完成。

5.3 FeedbackPieceDetail（点评曲目明细）
- 字段
  - id: UUID, 必填, PK
  - feedback_id: FK(FeedbackRecord), 必填, on_delete=CASCADE
  - piece_version_id: FK(PieceVersion), 必填, on_delete=PROTECT
  - course_version_id: FK(CourseVersion), 可选冗余, on_delete=PROTECT
  - lesson_version_id: FK(LessonVersion), 可选冗余, on_delete=PROTECT
  - [通用字段：created_*；支持软删]
- 约束
  - uq_feedback_piece(feedback_id, piece_version_id) 唯一
- 索引
  - idx_fpd_feedback(feedback_id), idx_fpd_piece_ver(piece_version_id)

5.4 StudentPieceStatus（学员曲目状态）
- 字段
  - id: UUID, 必填, PK
  - student_id: FK(Student), 必填, on_delete=CASCADE
  - piece_id: FK(Piece), 必填, on_delete=PROTECT（按“曲目身份”维度，不随版本）
  - reviewed_count: Integer, 必填, 默认=0（被点评次数）
  - last_reviewed_at: DateTime(UTC), 可空（最后点评时间）
  - [通用字段：created_*/updated_*；支持软删]
- 规则
  - 不做初始化/折算；仅随点评提交累计，随点评删除回滚（计数-1；如为最后一次则回退时间）。
- 约束
  - uq_student_piece(student_id, piece_id) 唯一
- 索引
  - idx_sps_student(student_id), idx_sps_piece(piece_id)

6. 提醒与公告
6.1 Reminder（提醒事项）
- 字段
  - id: UUID, 必填, PK
  - created_at: DateTime(UTC), 必填
  - urgency: Enum(Urgency), 必填
  - sender_id: FK(Person), 必填, on_delete=PROTECT
  - category: Enum(ReminderCategory), 必填
  - student_id: FK(Student), 可空, on_delete=SET_NULL
  - feedback_id: FK(FeedbackRecord), 可空, on_delete=SET_NULL
  - content: Text, 必填
  - start_at: DateTime(UTC), 可空（为空则按 created_at 计算）
  - end_at: DateTime(UTC), 可空（为空视为仍有效）
  - e2e_type: Enum(EndToEndType), 必填（自动推导）
  - [通用字段：updated_*；支持软删]
- 子表
  - ReminderRecipient：id(UUID) PK、reminder_id(FK, CASCADE)、person_id(FK Person, PROTECT)、is_read(Boolean, 默认=false)、read_at(DateTime)、[通用字段, 软删]
  - 约束：uq_recipient(reminder_id, person_id) 唯一
- 索引
  - idx_reminder_sender(sender_id), idx_reminder_student(student_id), idx_reminder_category(category), idx_reminder_urgency(urgency), idx_reminder_window(start_at, end_at)
  - idx_rr_person(person_id, is_read)

6.2 Announcement（公告）
- 字段
  - id: UUID, 必填, PK
  - type: Enum(AnnouncementType), 必填
  - content: Text, 必填
  - start_at: DateTime(UTC), 必填
  - end_at: DateTime(UTC), 可空（为空视为仍有效）
  - publisher_id: FK(Person), 必填, on_delete=PROTECT
  - [通用字段：created_*/updated_*；支持软删]
- 索引
  - idx_announce_window(start_at, end_at), idx_announce_type(type), idx_announce_publisher(publisher_id)

7. 回访与通知
7.1 FollowUpRecord（回访记录）
- 字段
  - id: UUID, 必填, PK
  - student_id: FK(Student), 必填, on_delete=PROTECT
  - seq_no: Integer, 必填（该学员第几次回访，唯一）
  - created_at: DateTime(UTC), 必填
  - status: Enum(FollowUpStatus), 必填（未处理/已处理/关闭）
  - purpose: Enum(FollowUpPurpose), 必填
  - urgency: Enum(UrgencyHL), 必填（high/medium/low）
  - content: Text, 必填
  - result: Text, 可空
  - need_follow_up: Boolean, 必填, 默认=false
  - next_follow_up_at: DateTime(UTC), 可空
  - operator_id: FK(Person), 必填（回访人员=负责该回访的运营）, on_delete=PROTECT
  - [通用字段：updated_*；支持软删]
- 约束
  - uq_followup_seq(student_id, seq_no) 唯一
- 索引
  - idx_followup_student(student_id), idx_followup_operator(operator_id), idx_followup_status(status), idx_followup_urgency(urgency), idx_followup_created(created_at)
- 联动
  - 当 need_follow_up=true 或临近 next_follow_up_at 时，提前24小时自动生成提醒；接收人为 operator_id。

7.2 Notification（通知）
- 字段
  - id: UUID, 必填, PK
  - type: Enum(NotificationType), 必填
  - content: Text, 必填
  - link_type: Enum(LinkType), 必填（不扩展）
  - link_id: UUID, 可空
  - sender_id: FK(Person), 可空（系统或人员）, on_delete=SET_NULL
  - receiver_id: FK(Person), 必填, on_delete=CASCADE
  - is_read: Boolean, 必填, 默认=false
  - read_at: DateTime(UTC), 可空（逐条标记已读，不支持批量已读）
  - created_at: DateTime(UTC), 必填
  - [通用字段：updated_*；支持软删]
- 索引
  - idx_notify_receiver(receiver_id, is_read), idx_notify_type(type), idx_notify_created(created_at)

8. 导入批次与明细（用于失败行留痕，不导出失败报告）
8.1 ImportBatch
- 字段
  - id: UUID, 必填, PK
  - source: String(50), 必填（如 student_xlsx）
  - total_rows: Integer, 必填, 默认=0
  - success_rows: Integer, 必填, 默认=0
  - failed_rows: Integer, 必填, 默认=0
  - created_by: FK(Person), 必填
  - created_at: DateTime(UTC), 必填
  - [通用字段：updated_*；支持软删]
- 规则
  - 不设保留周期限制

8.2 ImportRow
- 字段
  - id: UUID, 必填, PK
  - batch_id: FK(ImportBatch), 必填, on_delete=CASCADE
  - raw_payload: JSON/Text, 必填（原始行）
  - parsed_xiaoe_id: String(64), 可空
  - parsed_nickname: String(100), 可空
  - status: Enum(ImportRowStatus), 必填（success/failed）
  - error_reason: Text, 可空（失败原因）
  - created_at: DateTime(UTC), 必填
  - [通用字段：updated_*；支持软删]
- 规则
  - 仅以 xiaoe_id 为唯一锚点；重复导入仅更新昵称
  - 输入文件中的“统计类字段”（完成任务数/打卡等）完全不入库
- 索引
  - idx_ir_batch(batch_id), idx_ir_status(status), idx_ir_xiaoe(parsed_xiaoe_id)

9. 枚举/字典清单（首版）
- EnableStatus: enabled, disabled
- LessonCategory: basic, zero_basic
- LessonFocus: wrist, arm, lift_finger（如需多选建议拆子表）
- PieceAttribute: etude, music, technique
- CourseLearnStatus: not_started, learning, finished, paused, transferred
- RecordStatus: active, closed
- TaskStatus: pending, done（或：uncompleted, completed；与文案保持一致）
- TaskSource: researcher, teacher
- Urgency: urgent, normal（提醒用）
- UrgencyHL: high, medium, low（回访用）
- ReminderCategory: poor_effect, attitude_issue, irregular_attendance, injury, live_suggestion, other
- EndToEndType: T2R, T2O, R2T, R2O, O2T, O2R
- AnnouncementType: injury_notice, teaching_reminder（可扩展）
- FollowUpStatus: pending, done, closed
- FollowUpPurpose: regular, issue_tracking, renewal_reminder, complaint_handling（可扩展为字典项）
- NotificationType: task_assigned, task_completed, reminder_received, follow_up_todo, announcement_published
- LinkType: evaluation_task, feedback_record, reminder, announcement, follow_up, student
- PersonStatus: active, inactive
- StudentStatus: enabled, disabled
- ImportRowStatus: success, failed

10. 外键 on_delete 策略建议（摘要）
- 指向“主档”的外键（Course/Lesson/Piece/Version/Person/Student）：以 PROTECT 为主，避免误删；少数允许 SET_NULL（如 sender_id）。
- “子表”指向“主表”：以 CASCADE 为主（如 FeedbackPieceDetail → FeedbackRecord、ReminderRecipient → Reminder、ImportRow → ImportBatch）。
- Student 禁止删除（无 deleted_at）；其他业务表软删优先。

